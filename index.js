import { Telegraf } from 'telegraf';  // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙƒØªØ¨Ø© Telegraf Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† node-telegram-bot-api
import ExcelJS from 'exceljs';  // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…ÙƒØªØ¨Ø© ExcelJS
import fetch from 'node-fetch';  // Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Dropbox
import dotenv from 'dotenv';  // Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©
import express from 'express';  // Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Express

dotenv.config();  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦ÙŠØ© Ù…Ù† Ù…Ù„Ù .env

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø³ÙŠØ±ÙØ± Express (Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Render Ø£Ùˆ ÙÙŠ Ø¨ÙŠØ¦Ø© Ù…Ø­Ù„ÙŠØ©)
const app = express();
const port = process.env.PORT || 4000;  // Ø§Ù„Ù…Ù†ÙØ° Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
app.get('/', (req, res) => {
    res.send('The server is running successfully.');
});

// Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¨Ù€ ØªÙˆÙƒÙ† Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
const token = process.env.TELEGRAM_BOT_TOKEN || '7560955160:AAHakMcFzXTDTd6wJpdqw2WNFdSW46w0524';  // Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø¨Ù€ ØªÙˆÙƒÙ† Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ

// Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙˆØª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Telegraf
const bot = new Telegraf(token);

// ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Excel
let data = [];

// Ø­ÙØ¸ Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† ÙŠØªÙØ§Ø¹Ù„ÙˆÙ† Ù…Ø¹ Ø§Ù„Ø¨ÙˆØª
let userIds = new Set(); // Set Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†

// Ø±ÙˆØ§Ø¨Ø· Ù…Ù„ÙØ§Øª Excel ÙÙŠ Dropbox
const DROPBOX_FILE_URLS = [
    'https://www.dropbox.com/scl/fi/cdoawhmor12kz9vash45z/upload.xlsx?rlkey=b9rcfe3ell1e5tpgimc71sa5m&st=x5mwvyzm&dl=1',
    'https://www.dropbox.com/scl/fi/5eu49co5t4adlwcuf31cb/kan.xlsx?rlkey=uxcigf215rg0xojcpq73olyf7&st=l2ak33gq&dl=1',
    'https://www.dropbox.com/scl/fi/wzr3ixwn9cvxwnh3k2x85/rfh.xlsx?rlkey=25ty5w4p9iw01pr37lo3l028f&st=39ikyxsg&dl=1',
];

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¹Ø¯Ø© Ù…Ù„ÙØ§Øª Excel Ù…Ù† Dropbox
async function fetchExcelData() {
    try {
        for (const fileUrl of DROPBOX_FILE_URLS) {
            const response = await fetch(fileUrl);
            if (!response.ok) {
                throw new Error('âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ù…Ù† Dropbox');
            }
            const buffer = await response.buffer();
            const workbook = new ExcelJS.Workbook();
            await workbook.xlsx.load(buffer);

            const worksheet = workbook.worksheets[0];
            worksheet.eachRow((row) => {
                const idNumber = row.getCell(1).value?.toString().trim();
                const name = row.getCell(2).value?.toString().trim();
                const province = row.getCell(3).value?.toString().trim();
                const district = row.getCell(4).value?.toString().trim();
                const area = row.getCell(5).value?.toString().trim();
                const distributorId = row.getCell(6).value?.toString().trim();
                const distributorName = row.getCell(7).value?.toString().trim();
                const distributorPhone = row.getCell(8).value?.toString().trim();
                const status = row.getCell(9).value?.toString().trim();

                if (idNumber && name) {
                    data.push({
                        idNumber,
                        name,
                        province: province || "ØºÙŠØ± Ù…ØªÙˆÙØ±",
                        district: district || "ØºÙŠØ± Ù…ØªÙˆÙØ±",
                        area: area || "ØºÙŠØ± Ù…ØªÙˆÙØ±",
                        distributorId: distributorId || "ØºÙŠØ± Ù…ØªÙˆÙØ±",
                        distributorName: distributorName || "ØºÙŠØ± Ù…ØªÙˆÙØ±",
                        distributorPhone: distributorPhone || "ØºÙŠØ± Ù…ØªÙˆÙØ±",
                        status: status || "ØºÙŠØ± Ù…ØªÙˆÙØ±",
                    });
                }
            });
        }

        console.log('ðŸ“ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Dropbox Ø¨Ù†Ø¬Ø§Ø­.');
    } catch (error) {
        console.error('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø£Ùˆ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Dropbox:', error.message);
    }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Dropbox Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
fetchExcelData();

// Ù‚Ø§Ø¦Ù…Ø© Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†
const adminIds = process.env.ADMIN_IDS?.split(',') || ['7719756994'];  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†

// Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª
bot.start((ctx) => {
    const chatId = ctx.chat.id;
    userIds.add(chatId);  // Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…

    const options = {
        reply_markup: {
            keyboard: [
                [{ text: "ðŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…" }],
                [{ text: "ðŸ“ž Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„" }, { text: "ðŸ“– Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ø¨ÙˆØª" }],
            ],
            resize_keyboard: true,
            one_time_keyboard: false,
        },
    };

    if (adminIds.includes(chatId.toString())) {
        options.reply_markup.keyboard.push([{ text: "ðŸ“¢ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹" }]);
    }

    ctx.reply("Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ! Ø§Ø®ØªØ± Ø£Ø­Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:", options);
});

// Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
bot.on('text', (ctx) => {
    const chatId = ctx.chat.id;
    const input = ctx.message.text.trim();  // Ù…Ø¯Ø®Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…

    if (input === '/start' || input.startsWith('/')) return;  // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø£Ø®Ø±Ù‰

    if (input === "ðŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…") {
        ctx.reply("ðŸ“ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø£Ùˆ Ø§Ù„Ø§Ø³Ù… Ù„Ù„Ø¨Ø­Ø«:");
    } else if (input === "ðŸ“ž Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„") {
        const contactMessage = `
ðŸ“ž **Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„:**
Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¯Ø¹Ù… Ø£Ùˆ Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø±ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ø¹Ø¨Ø±:

- ðŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: [mrahel1991@gmail.com]
- ðŸ“± Ø¬ÙˆØ§Ù„ : [0598550144]
- ðŸ’¬ ØªÙ„ØºØ±Ø§Ù… : [https://t.me/AhmedGarqoud]
        `;
        ctx.reply(contactMessage, { parse_mode: 'Markdown' });
    } else if (input === "ðŸ“– Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ø¨ÙˆØª") {
        const aboutMessage = `
ðŸ¤– **Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ø¨ÙˆØª:**
Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª ÙŠØªÙŠØ­ Ù„Ùƒ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙŠÙ† Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø£Ùˆ Ø§Ù„Ø§Ø³Ù….

- ÙŠØªÙ… Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø·Ù† Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ²Ø¹ ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨.
- Ù‡Ø¯ÙÙ†Ø§ Ù‡Ùˆ ØªØ³Ù‡ÙŠÙ„ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.

ðŸ”§ **Ø§Ù„ØªØ·ÙˆÙŠØ± ÙˆØ§Ù„ØµÙŠØ§Ù†Ø©**: ØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª Ø¨ÙˆØ§Ø³Ø·Ø© [Ø§Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø§Ø¨Ùˆ ØºØ±Ù‚ÙˆØ¯].
        `;
        ctx.reply(aboutMessage, { parse_mode: 'Markdown' });
    } else {
        const user = data.find((entry) => entry.idNumber === input || entry.name === input);

        if (user) {
            const response = `
ðŸ” **ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨:**

ðŸ‘¤ **Ø§Ù„Ø§Ø³Ù…**: ${user.name}
ðŸ˜ï¸ **Ø§Ù„Ø­ÙŠ / Ø§Ù„Ù…Ù†Ø·Ù‚Ø©**: ${user.area}
ðŸ™ï¸ **Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©**: ${user.district}
ðŸ“ **Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©**: ${user.province}

ðŸ“› **Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ²Ø¹**: ${user.distributorName}
ðŸ“ž **Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…ÙˆØ²Ø¹**: ${user.distributorPhone}
ðŸ†” **Ù‡ÙˆÙŠØ© Ø§Ù„Ù…ÙˆØ²Ø¹**: ${user.distributorId}

ðŸ“œ **Ø§Ù„Ø­Ø§Ù„Ø©**: ${user.status}
            `;
            ctx.reply(response, { parse_mode: 'Markdown' });
        } else {
            ctx.reply("âš ï¸ Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø¯Ø®Ù„ Ø§Ù„Ù…Ù‚Ø¯Ù….");
        }
    }
});

// Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©
async function sendBroadcastMessage(message, adminChatId) {
    userIds.forEach(userId => {
        bot.telegram.sendMessage(userId, message);
    });
    bot.telegram.sendMessage(adminChatId, "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­.");
}

// Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†
function sendMessageToAdmins(message) {
    adminIds.forEach(adminId => {
        bot.telegram.sendMessage(adminId, message);
    });
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±
app.listen(port, () => {
    console.log(`Server is running on port ${port}`);
});
